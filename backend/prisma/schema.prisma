// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      String   @default("STUDENT")
  emailConfirmed Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tutor   Tutor?
  student Student?
  withdrawals Withdrawal[]
}

model Student {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName String?
  lastName  String?
  profileImage String?
  gender    String?
  grade     String?
  tagline   String?
  bio       String?
  country   String?
  state     String?
  city      String?
  address   String?
  zipcode   String?
  languagesSpoken String?
  learningPreferences String?
  introduction String?
  profileCompleted Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Add more student-specific fields as needed
  bookings Booking[]
  payments Payment[]
  savedTutors StudentSavedTutor[]
}

model Tutor {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal Information
  firstName    String?
  lastName     String?
  gender       String?
  gradesCanTeach String? // Stored as JSON string of string[]
  hourlyFee    Float?
  tagline      String?
  country      String?
  state        String?
  city         String?
  address      String?
  zipcode      String?
  languagesSpoken String? // Stored as JSON string of string[]
  
  // Profile image
  profileImage String?
  
  // Stripe
  stripeAccountId String?
  stripeOnboarded Boolean @default(false)
  
  // Background Check
  backgroundCheckCompleted Boolean @default(false)
  
  // Profile completion percentage
  profileCompletionPercentage Int @default(0)
  profileCompleted Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  experiences      Experience[]
  educations       Education[]
  subjects         TutorSubject[]
  availabilities   Availability[]
  backgroundCheck  BackgroundCheck?
  bookings         Booking[]
  payments         Payment[]
  savedByStudents  StudentSavedTutor[]
}

model Experience {
  id          String   @id @default(uuid())
  tutorId     String
  tutor       Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  
  jobTitle    String
  company     String
  location    String
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean  @default(false)
  teachingMode String
  description String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Education {
  id          String   @id @default(uuid())
  tutorId     String
  tutor       Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  
  degreeTitle String
  university  String
  location    String
  startDate   DateTime
  endDate     DateTime?
  isOngoing   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Subject {
  id        String    @id @default(uuid())
  name      String    @unique
  parentId  String?
  parent    Subject?  @relation("SubjectHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Subject[] @relation("SubjectHierarchy")
  tutors    TutorSubject[]
}

model TutorSubject {
  id        String   @id @default(uuid())
  tutorId   String
  tutor     Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([tutorId, subjectId])
}

model Availability {
  id            String   @id @default(uuid())
  tutorId       String
  tutor         Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  
  blockTitle    String
  daysAvailable String // Stored as JSON string of string[]
  startTime     String   // Format: "HH:MM"
  endTime       String   // Format: "HH:MM"
  breakTime     Int      // in minutes
  sessionDuration Int    // in minutes
  numberOfSlots Int      @default(1)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model BackgroundCheck {
  id                String   @id @default(uuid())
  tutorId           String   @unique
  tutor             Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  
  fullLegalFirstName String
  fullLegalLastName  String
  otherNamesUsed     String?
  
  addressLine1      String
  addressLine2      String?
  city              String
  stateProvinceRegion String
  postalCode        String
  country           String
  livedMoreThan3Years Boolean
  
  dateOfBirth       DateTime
  socialSecurityNumber String // Should be encrypted in production
  hasUSDriverLicense Boolean
  
  email             String
  consentGiven      Boolean
  comments          String?
  
  status            String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Booking {
  id         String   @id @default(uuid())
  studentId  String
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tutorId    String
  tutor      Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  
  startTime  DateTime
  endTime    DateTime
  status     String   @default("PENDING") // PENDING, CONFIRMED, CANCELLED, COMPLETED
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  classSession ClassSession?
  payment      Payment?
}

model ClassSession {
  id          String   @id @default(uuid())
  bookingId   String   @unique
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  googleClassroomId String? // Google Classroom course/class ID
  googleClassroomLink String?
  googleMeetLink     String?
  
  status      String   @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  completedAt DateTime?
  tutorApproved Boolean @default(false)
  adminApproved Boolean @default(false)
  adminApprovedAt DateTime?
  
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Payment {
  id          String   @id @default(uuid())
  bookingId   String   @unique
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tutorId     String
  tutor       Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  
  amount      Float    // Total amount paid by student
  currency    String   @default("USD")
  
  // Commission breakdown
  adminCommissionPercentage Float @default(10.0)
  adminCommissionFixed      Float @default(0.0)
  adminCommissionAmount     Float // Calculated commission
  tutorAmount               Float // Amount tutor receives
  
  // Stripe
  stripePaymentIntentId String?
  stripeChargeId        String?
  paymentStatus         String   @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  
  paidAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model StudentSavedTutor {
  id        String   @id @default(uuid())
  studentId String
  tutorId   String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tutor     Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([studentId, tutorId])
}

model Withdrawal {
  id          String   @id @default(uuid())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userType    String   // "ADMIN", "TUTOR", or "STUDENT"
  method      String?
  
  amount      Float
  currency    String   @default("USD")
  charge      Float?   @default(0)
  netAmount   Float?   @default(0)
  
  // Stripe
  stripeTransferId String?
  stripePayoutId   String?
  
  status      String   @default("PENDING") // PENDING, APPROVED, PROCESSING, COMPLETED, REJECTED
  requestedAt DateTime @default(now())
  approvedAt  DateTime?
  processedAt DateTime?
  completedAt DateTime?
  
  // Approval settings
  autoApproveAfterDays Int? // null means manual approval, number means auto-approve after N days
  approvedBy   String? // Admin user ID who approved
  
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AdminSettings {
  id                          String   @id @default(uuid())
  sendSignupConfirmation      Boolean  @default(true)
  sendProfileCompletionEmail  Boolean  @default(true)
  autoApproveUsers            Boolean  @default(true)
  
  // Commission Settings
  adminCommissionPercentage   Float    @default(10.0)
  adminCommissionFixed        Float    @default(0.0)
  
  // Withdrawal Settings
  withdrawalAutoApproveDays   Int?     // null = manual, number = auto-approve after N days (default 2 for sandbox)
  withdrawMethods             String?  @default("[]") // JSON array of supported methods
  withdrawFixedCharge         Float?   @default(0)
  withdrawPercentageCharge    Float?   @default(0)
  minimumWithdrawAmount       Float?
  minimumBalanceForWithdraw   Float?
  withdrawThreshold           Int?

  // Profile field visibility
  genderFieldEnabled          Boolean  @default(true)
  gradeFieldEnabled           Boolean  @default(true)
  stateFieldEnabled           Boolean  @default(true)

  // Branding & email
  emailLogo                   String?
  emailSenderName             String?
  emailSenderEmail            String?
  emailFooterCopyright        String?
  emailSenderSignature        String?
  emailFooterColor            String?  @default("#F5F5F5")

  // Default avatars
  defaultStudentImage         String?
  defaultTutorImage           String?
  
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
}

model EmailTemplate {
  id          String   @id @default(uuid())
  name        String   @unique // SIGNUP_SUCCESS, PROFILE_COMPLETE, EMAIL_VERIFICATION, FORGOT_PASSWORD, CLASS_APPROVED, PAYMENT_RECEIVED, WITHDRAWAL_APPROVED, etc.
  subject     String
  htmlBody    String   @default("")
  textBody    String   @default("")
  isActive    Boolean  @default(true)
  
  // Template variables documentation (stored as JSON string)
  variables   String?  // JSON array of available variables like {{userName}}, {{email}}, etc.
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

